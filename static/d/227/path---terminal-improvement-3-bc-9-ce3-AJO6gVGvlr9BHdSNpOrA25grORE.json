{"data":{"site":{"siteMetadata":{"title":"Lucian Buzzo","author":"Lucian Buzzo"}},"markdownRemark":{"id":"8a1f107b-960c-5b19-9708-763a67f9927f","excerpt":"After improving the prompt in my terminal I was pretty happy with it (see  part\n2 of this series ), unfortunately as soon as I fired\nup an…","html":"<p>After improving the prompt in my terminal I was pretty happy with it (see [part\n2 of this series][./terminal-improvement-2]), unfortunately as soon as I fired\nup an SSH session I was seeing the “bleurgh” prompt again.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/lucian-buzzo-blog/static/1c777bc2492dcf54dd2ef433d89ce164/8a142/ssh-bad.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 569px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 3.8664323374340945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAANklEQVQI12N4/fzG/8/v7v7/+OY2kL7z/9PbO/+/vr/7//2rW/9/fHrw/++3x///fH0EponBAOfsS8gnZTAjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Default ssh prompt\"\n        title=\"\"\n        src=\"/lucian-buzzo-blog/static/1c777bc2492dcf54dd2ef433d89ce164/8a142/ssh-bad.png\"\n        srcset=\"/lucian-buzzo-blog/static/1c777bc2492dcf54dd2ef433d89ce164/3b8d9/ssh-bad.png 148w,\n/lucian-buzzo-blog/static/1c777bc2492dcf54dd2ef433d89ce164/c9c62/ssh-bad.png 295w,\n/lucian-buzzo-blog/static/1c777bc2492dcf54dd2ef433d89ce164/8a142/ssh-bad.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Getting around this problem wasn’t too hard, I set up a git repository for all\nmy dot files (<code class=\"language-text\">.vimrc</code>, <code class=\"language-text\">.bash_profile</code>, etc) and created a bash script to\nsymlink the files to my home directory. Now all I had to do was <code class=\"language-text\">git clone</code> and\nrun my setup script and I could have the same prompt (and Vim config) in my SSH.</p>\n<p>“Lovely” I thought to myself, but now my SSH session looks exactly the same as\nmy normal Terminal session, how am I going to be able to tell the difference?\nWhat if I accidentally kill a production server because I got confused?</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/lucian-buzzo-blog/static/6fdb60d81c6e2ce37db2393f01dcfbf5/859f1/custom-bad.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 314px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 21.337579617834397%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAUElEQVQY02N48+zq/7fPr/3/9OnB/88f7v3/9+3x/z9fH/3/C6TJwQxf3935//X93f+/gIb8+vIQLEiRgf++P/kPwjABSgwDGwgyABlTaigAMWsx1VwaV3cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Custom prompt dissaproves\"\n        title=\"\"\n        src=\"/lucian-buzzo-blog/static/6fdb60d81c6e2ce37db2393f01dcfbf5/859f1/custom-bad.png\"\n        srcset=\"/lucian-buzzo-blog/static/6fdb60d81c6e2ce37db2393f01dcfbf5/b7574/custom-bad.png 148w,\n/lucian-buzzo-blog/static/6fdb60d81c6e2ce37db2393f01dcfbf5/94149/custom-bad.png 295w,\n/lucian-buzzo-blog/static/6fdb60d81c6e2ce37db2393f01dcfbf5/859f1/custom-bad.png 314w\"\n        sizes=\"(max-width: 314px) 100vw, 314px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Solving this problem came in two parts.</p>\n<p>Firstly, I needed to be able to differentiate between a “normal” session and an\nSSH session. I did some digging on <a href=\"http://stackoverflow.com/\">stackoverflow</a> and found this little gem.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> is_ssh<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -n <span class=\"token string\">\"<span class=\"token variable\">$SSH_CLIENT</span>\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span> -n <span class=\"token string\">\"<span class=\"token variable\">$SSH_TTY</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">return</span> 0\n  <span class=\"token comment\"># many other tests omitted</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">case</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -o comm<span class=\"token operator\">=</span> -p $PPID<span class=\"token variable\">)</span></span> <span class=\"token keyword\">in</span>\n      sshd<span class=\"token operator\">|</span>*/sshd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> 0<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span>\n    esac\n  <span class=\"token keyword\">fi</span>\n  <span class=\"token keyword\">return</span> 1\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The function detects SSH environment variables and will return <code class=\"language-text\">true</code> if they are\navailable (indicating an SSH session is active).</p>\n<p>Secondly, I needed to be able to change the output of my prompt based on what type\nof session I’m in. This was fairly straight forward to cobble together. I\ncreated a function that returns a prompt based on the result of <code class=\"language-text\">is_ssh</code> and\nthen assigned it to <code class=\"language-text\">export PS1</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> get_prompt <span class=\"token punctuation\">{</span>\n  c<span class=\"token operator\">=</span><span class=\"token string\">\"\\[\\033[\"</span>\n  p<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${c}</span>38;5;136\\]\"</span>\n\n  local_session<span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]ಠ_ಠ\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[<span class=\"token variable\"><span class=\"token variable\">$(</span>git_color<span class=\"token variable\">)</span></span>\\]<span class=\"token variable\"><span class=\"token variable\">$(</span>git_branch<span class=\"token variable\">)</span></span>\\[\\033[m\\] '</span>\n  ssh_session<span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]\\u\\[\\033[38;5;37m\\]@\\h\\[\\em\\]\\[\\033[38;5;125m\\] (\\@)\\[\\em\\]\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[<span class=\"token variable\"><span class=\"token variable\">$(</span>git_color<span class=\"token variable\">)</span></span>\\]<span class=\"token variable\"><span class=\"token variable\">$(</span>git_branch<span class=\"token variable\">)</span></span>\\[\\033[m\\] '</span>\n\n  n<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${c}</span>m]\"</span>\n  <span class=\"token keyword\">if</span> is_ssh<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">echo</span> -e <span class=\"token string\">\"<span class=\"token variable\">${ssh_session}</span>\"</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">echo</span> -e <span class=\"token string\">\"<span class=\"token variable\">${local_session}</span>\"</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">export</span> PS1<span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>get_prompt<span class=\"token variable\">)</span></span></code></pre></div>\n<p>The prompt returned by the function when I’m in an SSH session shows the standard\n<code class=\"language-text\">user@host</code> ( <code class=\"language-text\">\\u@\\h</code> ) as well as the current time ( <code class=\"language-text\">\\@</code> ).\nNow I can quickly see if I’m on a remote machine and ensure that no horrible\ncommand line related accidents happen!</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/lucian-buzzo-blog/static/6a3e77c29d28c90fe0f8f5e04ed50614/8a142/ssh-better.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 569px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 5.975395430579965%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAQElEQVQI12P49Prm/3cvb/x/9e7u//cfH/z/AMTvP97///3t3f8/n978/+PFrf8/vz76//fb4/9/gPQfKBsXBgDg9kufSGLiVQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"A better SSH prompt\"\n        title=\"\"\n        src=\"/lucian-buzzo-blog/static/6a3e77c29d28c90fe0f8f5e04ed50614/8a142/ssh-better.png\"\n        srcset=\"/lucian-buzzo-blog/static/6a3e77c29d28c90fe0f8f5e04ed50614/3b8d9/ssh-better.png 148w,\n/lucian-buzzo-blog/static/6a3e77c29d28c90fe0f8f5e04ed50614/c9c62/ssh-better.png 295w,\n/lucian-buzzo-blog/static/6a3e77c29d28c90fe0f8f5e04ed50614/8a142/ssh-better.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>One thing still bugged me about this prompt though. The host name <code class=\"language-text\">ip-172-31-9-157</code>\nis pretty useless to me. I, like many other developers and sysadmins out there, use a\nhost config file to create aliases for the machine I work on. A typical entry in\nthis file looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Host myserver\n  Hostname 123.45.6.78\n  User ec2-user\n  IdentityFile ~/path/to/some/private/key</code></pre></div>\n<p>With this config file I can connect to a machine by typing <code class=\"language-text\">ssh myserver</code> instead of\n<code class=\"language-text\">ssh ec2-user@123.45.6.78</code>. If I could get the prompt to display the alias\nI had set then I would definitely know which server I was one. However this is\nmuch easier said than done and coming up with a clean method of doing it proved\nto be a bit tricky.</p>\n<p>One option would be to <a href=\"http://www.cyberciti.biz/faq/linux-change-hostname/\">change the hostname</a> within the machine itself, however\nthis was something I wanted to avoid for a number of reasons.</p>\n<ul>\n<li>Setting up a hostname on each machine I work on would be massively time consuming and pretty\nboring.</li>\n<li>If I ever changed my local alias I’d have to update the machines hostname.</li>\n<li>If a team mate logged onto a server it could cause problems for them.</li>\n</ul>\n<p>What I needed was an approach that involved as little setup as possible, that left\nthe machines hostname untouched and could update dynamically based on my local\nconfig.</p>\n<p>The solution I came up with feels like a bit of a hack but has been working\nwithout issue.\nIn essence, I use the <code class=\"language-text\">[command]</code> parameter of <code class=\"language-text\">ssh</code> to set a Bash variable\nand then open a new bash session before the SSH connection closes.\nI created a function in my <code class=\"language-text\">.bash_profile</code> called <strong>tunnel</strong> that wraps the ssh command and adds\narguments, passing my hostname alias through the <code class=\"language-text\">[command]</code> parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> tunnel <span class=\"token punctuation\">{</span>\n  local HOSTALIAS<span class=\"token operator\">=</span><span class=\"token string\">\"'export MYHOSTALIAS=<span class=\"token variable\">$1</span>; /bin/bash -il'\"</span>\n  <span class=\"token function\">ssh</span> <span class=\"token string\">\"<span class=\"token variable\">$@</span>\"</span> -t \\'<span class=\"token string\">\"<span class=\"token variable\">$HOSTALIAS</span>\"</span>\\'\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the ssh session bash prompt I replaced the <a href=\"http://www.tldp.org/HOWTO/Bash-Prompt-HOWTO/bash-prompt-escape-sequences.html\">“escape sequence”</a> for the current\nmachines hostname (<code class=\"language-text\">\\h</code>) with a function call. This function will return the\nthe value of the variable <code class=\"language-text\">MYHOSTALIAS</code> or the current machines hostname if it\nisn’t available.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> host_alias <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -z <span class=\"token string\">\"<span class=\"token variable\">$MYHOSTALIAS</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">echo</span> -e <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span> -s<span class=\"token variable\">)</span></span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token variable\">$MYHOSTALIAS</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The resulting prompt string now looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ssh_session<span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]\\u\\[\\033[38;5;37m\\]@<span class=\"token variable\"><span class=\"token variable\">$(</span>host_alias<span class=\"token variable\">)</span></span>\\[\\em\\]\\[\\033[38;5;125m\\] (\\@)\\[\\em\\]\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[<span class=\"token variable\"><span class=\"token variable\">$(</span>git_color<span class=\"token variable\">)</span></span>\\]<span class=\"token variable\"><span class=\"token variable\">$(</span>git_branch<span class=\"token variable\">)</span></span>\\[\\033[m\\] '</span></code></pre></div>\n<p>And the rendered bash prompt now looks like this:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/lucian-buzzo-blog/static/4148050c0be713bf48fc97e1c7821eaf/5439f/ssh-bestest.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 570px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 4.912280701754386%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAN0lEQVQI12P48OrG/2evb/9//eH+/y/v7v3/9fzW/x+Pb/z/DmT/+fb4/9+vj/7/AeK/IDYRGADohUvO9nz0ywAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"The bestest ssh prompt\"\n        title=\"\"\n        src=\"/lucian-buzzo-blog/static/4148050c0be713bf48fc97e1c7821eaf/5439f/ssh-bestest.png\"\n        srcset=\"/lucian-buzzo-blog/static/4148050c0be713bf48fc97e1c7821eaf/2349c/ssh-bestest.png 148w,\n/lucian-buzzo-blog/static/4148050c0be713bf48fc97e1c7821eaf/2eaa1/ssh-bestest.png 295w,\n/lucian-buzzo-blog/static/4148050c0be713bf48fc97e1c7821eaf/5439f/ssh-bestest.png 570w\"\n        sizes=\"(max-width: 570px) 100vw, 570px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Now I have no problem seeing which server I’m on and I’m not going to be annoying\nany co-workers!</p>\n<p>My Terminal <em>feels</em> right for me, it’s really only cosmetic differences that\ni’ve discussed but it’s had a huge difference on my user experience.\nBy making the software my own I’ve ended up with something that\nI actually enjoy using and my work is that much better for it.</p>","frontmatter":{"title":"How to improve your Mac’s terminal part 3 - changing prompt in an SSH session","date":"April 19, 2015"}}},"pageContext":{"slug":"/terminal-improvement-3/","previous":{"fields":{"slug":"/terminal-improvement-2/"},"frontmatter":{"title":"How to improve your Mac’s terminal part 2 - the prompt"}},"next":{"fields":{"slug":"/drupal-field-deployment/"},"frontmatter":{"title":"How to painlessly deploy Drupal fields"}}}}