{"componentChunkName":"component---src-templates-blog-post-js","path":"/terminal-improvement-3/","result":{"data":{"site":{"siteMetadata":{"title":"Living Life on the Outside","author":"Lucian Buzzo"}},"markdownRemark":{"id":"e3ae9caf-4b52-582f-8d2a-d68920b24732","excerpt":"After improving the prompt in my terminal I was pretty happy with it (see [part\n2 of this series][./terminal-improvement-2]), unfortunately…","html":"<p>After improving the prompt in my terminal I was pretty happy with it (see [part\n2 of this series][./terminal-improvement-2]), unfortunately as soon as I fired\nup an SSH session I was seeing the “bleurgh” prompt again.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 569px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1c777bc2492dcf54dd2ef433d89ce164/854dc/ssh-bad.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 4.0540540540540535%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAOElEQVR42mN4/fzG/8/v7vz/8Ob2/y/v7/7/+Ob2/6/v7/3/8PrW/+8f7///++3x/z9fH4FpYjAA53ZLxinIxM0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Default ssh prompt\"\n        title=\"\"\n        src=\"/static/1c777bc2492dcf54dd2ef433d89ce164/854dc/ssh-bad.png\"\n        srcset=\"/static/1c777bc2492dcf54dd2ef433d89ce164/12f09/ssh-bad.png 148w,\n/static/1c777bc2492dcf54dd2ef433d89ce164/e4a3f/ssh-bad.png 295w,\n/static/1c777bc2492dcf54dd2ef433d89ce164/854dc/ssh-bad.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Getting around this problem wasn’t too hard, I set up a git repository for all\nmy dot files (<code class=\"language-text\">.vimrc</code>, <code class=\"language-text\">.bash_profile</code>, etc) and created a bash script to\nsymlink the files to my home directory. Now all I had to do was <code class=\"language-text\">git clone</code> and\nrun my setup script and I could have the same prompt (and Vim config) in my SSH.</p>\n<p>“Lovely” I thought to myself, but now my SSH session looks exactly the same as\nmy normal Terminal session, how am I going to be able to tell the difference?\nWhat if I accidentally kill a production server because I got confused?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 314px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6fdb60d81c6e2ce37db2393f01dcfbf5/5b158/custom-bad.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASElEQVR42mN4+fjS/9fPrv7/9OnB/68f7v3/9+3x/z9fH/3/++0xWZjhx8f7/39+evD/z1eEQRQZiC5AiWFgA0EGgPE36rgQADh0MeCpoMSXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Custom prompt dissaproves\"\n        title=\"\"\n        src=\"/static/6fdb60d81c6e2ce37db2393f01dcfbf5/5b158/custom-bad.png\"\n        srcset=\"/static/6fdb60d81c6e2ce37db2393f01dcfbf5/12f09/custom-bad.png 148w,\n/static/6fdb60d81c6e2ce37db2393f01dcfbf5/e4a3f/custom-bad.png 295w,\n/static/6fdb60d81c6e2ce37db2393f01dcfbf5/5b158/custom-bad.png 314w\"\n        sizes=\"(max-width: 314px) 100vw, 314px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Solving this problem came in two parts.</p>\n<p>Firstly, I needed to be able to differentiate between a “normal” session and an\nSSH session. I did some digging on <a href=\"http://stackoverflow.com/\">stackoverflow</a> and found this little gem.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> <span class=\"token function-name function\">is_ssh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$SSH_CLIENT</span>\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$SSH_TTY</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span>\n  <span class=\"token comment\"># many other tests omitted</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">case</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">comm</span><span class=\"token operator\">=</span> <span class=\"token parameter variable\">-p</span> <span class=\"token environment constant\">$PPID</span><span class=\"token variable\">)</span></span> <span class=\"token keyword\">in</span>\n      sshd<span class=\"token operator\">|</span>*/sshd<span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">esac</span>\n  <span class=\"token keyword\">fi</span>\n  <span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The function detects SSH environment variables and will return <code class=\"language-text\">true</code> if they are\navailable (indicating an SSH session is active).</p>\n<p>Secondly, I needed to be able to change the output of my prompt based on what type\nof session I’m in. This was fairly straight forward to cobble together. I\ncreated a function that returns a prompt based on the result of <code class=\"language-text\">is_ssh</code> and\nthen assigned it to <code class=\"language-text\">export PS1</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> <span class=\"token function-name function\">get_prompt</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token assign-left variable\">c</span><span class=\"token operator\">=</span><span class=\"token string\">\"\\[<span class=\"token entity\" title=\"\\033\">\\033</span>[\"</span>\n  <span class=\"token assign-left variable\">p</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${c}</span>38;5;136\\]\"</span>\n\n  <span class=\"token assign-left variable\">local_session</span><span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]ಠ_ಠ\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[$(git_color)\\]$(git_branch)\\[\\033[m\\] '</span>\n  <span class=\"token assign-left variable\">ssh_session</span><span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]\\u\\[\\033[38;5;37m\\]@\\h\\[\\em\\]\\[\\033[38;5;125m\\] (\\@)\\[\\em\\]\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[$(git_color)\\]$(git_branch)\\[\\033[m\\] '</span>\n\n  <span class=\"token assign-left variable\">n</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${c}</span>m]\"</span>\n  <span class=\"token keyword\">if</span> is_ssh<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token variable\">${ssh_session}</span>\"</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token variable\">${local_session}</span>\"</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>get_prompt<span class=\"token variable\">)</span></span></code></pre></div>\n<p>The prompt returned by the function when I’m in an SSH session shows the standard\n<code class=\"language-text\">user@host</code> ( <code class=\"language-text\">\\u@\\h</code> ) as well as the current time ( <code class=\"language-text\">\\@</code> ).\nNow I can quickly see if I’m on a remote machine and ensure that no horrible\ncommand line related accidents happen!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 569px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6a3e77c29d28c90fe0f8f5e04ed50614/854dc/ssh-better.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.081081081081082%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPUlEQVR42nXGQQqAIBRAwe5/xAwR3Uih4UelpHiiexcDs+WgSNdOvDUiZkpieKKmecV7HrRi+avjK3YaX+nsMkvM0w59lQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A better SSH prompt\"\n        title=\"\"\n        src=\"/static/6a3e77c29d28c90fe0f8f5e04ed50614/854dc/ssh-better.png\"\n        srcset=\"/static/6a3e77c29d28c90fe0f8f5e04ed50614/12f09/ssh-better.png 148w,\n/static/6a3e77c29d28c90fe0f8f5e04ed50614/e4a3f/ssh-better.png 295w,\n/static/6a3e77c29d28c90fe0f8f5e04ed50614/854dc/ssh-better.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>One thing still bugged me about this prompt though. The host name <code class=\"language-text\">ip-172-31-9-157</code>\nis pretty useless to me. I, like many other developers and sysadmins out there, use a\nhost config file to create aliases for the machine I work on. A typical entry in\nthis file looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Host myserver\n  Hostname 123.45.6.78\n  User ec2-user\n  IdentityFile ~/path/to/some/private/key</code></pre></div>\n<p>With this config file I can connect to a machine by typing <code class=\"language-text\">ssh myserver</code> instead of\n<code class=\"language-text\">ssh ec2-user@123.45.6.78</code>. If I could get the prompt to display the alias\nI had set then I would definitely know which server I was one. However this is\nmuch easier said than done and coming up with a clean method of doing it proved\nto be a bit tricky.</p>\n<p>One option would be to <a href=\"http://www.cyberciti.biz/faq/linux-change-hostname/\">change the hostname</a> within the machine itself, however\nthis was something I wanted to avoid for a number of reasons.</p>\n<ul>\n<li>Setting up a hostname on each machine I work on would be massively time consuming and pretty</li>\n</ul>\n<p>boring.</p>\n<ul>\n<li>If I ever changed my local alias I’d have to update the machines hostname.</li>\n<li>If a team mate logged onto a server it could cause problems for them.</li>\n</ul>\n<p>What I needed was an approach that involved as little setup as possible, that left\nthe machines hostname untouched and could update dynamically based on my local\nconfig.</p>\n<p>The solution I came up with feels like a bit of a hack but has been working\nwithout issue.\nIn essence, I use the <code class=\"language-text\">[command]</code> parameter of <code class=\"language-text\">ssh</code> to set a Bash variable\nand then open a new bash session before the SSH connection closes.\nI created a function in my <code class=\"language-text\">.bash_profile</code> called <strong>tunnel</strong> that wraps the ssh command and adds\narguments, passing my hostname alias through the <code class=\"language-text\">[command]</code> parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> <span class=\"token function-name function\">tunnel</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">HOSTALIAS</span><span class=\"token operator\">=</span><span class=\"token string\">\"'export MYHOSTALIAS=<span class=\"token variable\">$1</span>; /bin/bash -il'\"</span>\n  <span class=\"token function\">ssh</span> <span class=\"token string\">\"<span class=\"token variable\">$@</span>\"</span> <span class=\"token parameter variable\">-t</span> <span class=\"token punctuation\">\\</span>'<span class=\"token string\">\"<span class=\"token variable\">$HOSTALIAS</span>\"</span><span class=\"token punctuation\">\\</span>'\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the ssh session bash prompt I replaced the <a href=\"http://www.tldp.org/HOWTO/Bash-Prompt-HOWTO/bash-prompt-escape-sequences.html\">“escape sequence”</a> for the current\nmachines hostname (<code class=\"language-text\">\\h</code>) with a function call. This function will return the\nthe value of the variable <code class=\"language-text\">MYHOSTALIAS</code> or the current machines hostname if it\nisn’t available.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">function</span> <span class=\"token function-name function\">host_alias</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$MYHOSTALIAS</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span> <span class=\"token parameter variable\">-s</span><span class=\"token variable\">)</span></span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$MYHOSTALIAS</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The resulting prompt string now looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">ssh_session</span><span class=\"token operator\">=</span><span class=\"token string\">'\\[\\033[38;5;240m\\]\\u\\[\\033[38;5;37m\\]@$(host_alias)\\[\\em\\]\\[\\033[38;5;125m\\] (\\@)\\[\\em\\]\\[\\e[m\\] \\[\\033[38;5;37m\\]\\W/\\[\\e[m\\]\\[$(git_color)\\]$(git_branch)\\[\\033[m\\] '</span></code></pre></div>\n<p>And the rendered bash prompt now looks like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4148050c0be713bf48fc97e1c7821eaf/432e7/ssh-bestest.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 4.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPklEQVR42oXGSwqAIBRA0fa/wkcYhokhpOTAD6JcaQUNDpzt9UL0gguKJ2lKOOj3TrNCTSejXMxsGNkwv/9Y4iNLsQ81NXkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The bestest ssh prompt\"\n        title=\"\"\n        src=\"/static/4148050c0be713bf48fc97e1c7821eaf/432e7/ssh-bestest.png\"\n        srcset=\"/static/4148050c0be713bf48fc97e1c7821eaf/12f09/ssh-bestest.png 148w,\n/static/4148050c0be713bf48fc97e1c7821eaf/e4a3f/ssh-bestest.png 295w,\n/static/4148050c0be713bf48fc97e1c7821eaf/432e7/ssh-bestest.png 570w\"\n        sizes=\"(max-width: 570px) 100vw, 570px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now I have no problem seeing which server I’m on and I’m not going to be annoying\nany co-workers!</p>\n<p>My Terminal <em>feels</em> right for me, it’s really only cosmetic differences that\ni’ve discussed but it’s had a huge difference on my user experience.\nBy making the software my own I’ve ended up with something that\nI actually enjoy using and my work is that much better for it.</p>","frontmatter":{"title":"How to improve your Mac’s terminal part 3 - changing prompt in an SSH session","date":"April 19, 2015"}}},"pageContext":{"slug":"/terminal-improvement-3/","previous":{"fields":{"slug":"/terminal-improvement-2/"},"frontmatter":{"title":"How to improve your Mac’s terminal part 2 - the prompt"}},"next":{"fields":{"slug":"/drupal-field-deployment/"},"frontmatter":{"title":"How to painlessly deploy Drupal fields"}}}},"staticQueryHashes":[],"slicesMap":{}}